name: Windows
on:
  push:
  pull_request:

jobs:
  build:
    name: Build
    runs-on: windows-latest
    env:
      target-name: Zentroid
      plantform-des: win
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4.1.1
        with:
          version: 6.5.3
          target: desktop
          arch: win64_msvc2019_64
          modules: qtmultimedia
          cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Generate Version
        shell: bash
        run: python ci/generate-version.py

      - name: CMake Configure
        shell: cmd
        run: |
          if exist build rmdir /s /q build
          mkdir build
          cd build
          cmake -DCMAKE_PREFIX_PATH="%QT_ROOT_DIR%" -DCMAKE_BUILD_TYPE=RelWithDebInfo -G "Visual Studio 17 2022" -A x64 ..

      - name: CMake Build
        shell: cmd
        run: |
          cd build
          cmake --build . --config RelWithDebInfo -j8

      - name: Get the version
        shell: bash
        id: get-version
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      - name: Package
        shell: cmd
        run: |
          set publish_dir=publish\%target-name%-win-x64
          if exist %publish_dir% rmdir /s /q %publish_dir%
          mkdir %publish_dir%
          xcopy output\x64\RelWithDebInfo\* %publish_dir%\ /E /Y
          "%QT_ROOT_DIR%\bin\windeployqt.exe" %publish_dir%\Zentroid.exe

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.target-name }}-win-x64
          path: publish/${{ env.target-name }}-win-x64/

      - name: Upload Release
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          Compress-Archive -Path "publish\${{ env.target-name }}-win-x64" -DestinationPath "publish\${{ env.target-name }}-win-x64-${{ steps.get-version.outputs.version }}.zip"

      - name: Upload Release Asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: publish/${{ env.target-name }}-win-x64-${{ steps.get-version.outputs.version }}.zip
          asset_name: ${{ env.target-name }}-win-x64-${{ steps.get-version.outputs.version }}.zip
          tag: ${{ github.ref }}
          overwrite: true
